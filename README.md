# Coder-de-Poet — Learnix

This README describes how to run the project locally, the authentication/authorization design, backend requirements and important decisions/tradeoffs.

## Contents
- Frontend: React app at `frontend/`
  - Main entry: [frontend/src/App.jsx](frontend/src/App.jsx)
  - Auth context: [frontend/src/contexts/AuthContext.jsx](frontend/src/contexts/AuthContext.jsx)
  - In-browser token handling: [frontend/src/services/authService.js](frontend/src/services/authService.js)
  - Mock API used in dev: [frontend/src/services/api.js](frontend/src/services/api.js)
- Backend (auth_service): ASP.NET Core Web API at `auth_service/`
  - App entry: [auth_service/Program.cs](auth_service/Program.cs)
  - JWT provider: [auth_service/Infrastructure/Security/JWTGenerator.cs](auth_service/Infrastructure/Security/JWTGenerator.cs)
  - User domain: [auth_service/Domain/Entity/User.cs](auth_service/Domain/Entity/User.cs)
  - EF DbContext & migrations: [auth_service/Infrastructure/Database/DbContext.cs](auth_service/Infrastructure/Database/DbContext.cs), migrations in [auth_service/Migrations/](auth_service/Migrations/)

---

## Run locally

Prerequisites:
- Node.js + npm for frontend
- .NET 9 SDK for backend
- PostgreSQL (or a Postgres-compatible connection string) if using the DB backend

Frontend (development):
1. Open a terminal at `frontend/`
2. Install: `npm install`
3. Start dev server: `npm start`  
   - App runs at http://localhost:3000 by default.

Frontend (production build):
1. `npm run build`
2. Serve the `build/` folder with any static server.

Backend (development):
1. Open a terminal at `auth_service/`
2. (Optional) Apply EF migrations to your Postgres DB:
   - Configure connection via environment variable `DATABASE_URL` or `ConnectionStrings:DefaultConnection` in appsettings.
   - Example DATABASE_URL (Heroku-style): `postgres://user:pass@host:port/dbname`
   - Run migrations (requires dotnet-ef tooling):  
     `dotnet ef database update --project .`  
     or use your preferred migration workflow.
3. Run API: `dotnet run`
   - Default configured URLs: http://localhost:5015 (see [auth_service/Properties/launchSettings.json](auth_service/Properties/launchSettings.json)).

Environment / secrets:
- JWT secret and other settings in `auth_service/appsettings.json` under `JWT`. In production, override via environment variables (recommended).
  - Example keys: `JWT:SecretKey`, `JWT:Issuer`, `JWT:Audience`.
- Database connection via `DATABASE_URL` environment variable or `DefaultConnection` in configuration.

---

## Authentication & Authorization design

Overview:
- Backend issues JWT access tokens (short-lived) and refresh tokens (longer-lived).
  - Access tokens are generated by the provider implemented at [auth_service/Infrastructure/Security/JWTGenerator.cs](auth_service/Infrastructure/Security/JWTGenerator.cs).
  - Refresh tokens are generated as random base64 strings and persisted on the User entity.

Frontend token handling:
- The frontend service stores access tokens in memory and mirrors into `sessionStorage` via [frontend/src/services/authService.js](frontend/src/services/authService.js):
  - setAccessToken(token) sets an internal field and calls `sessionStorage.setItem('accessToken', token)`.
  - getStoredToken() returns memory token or `sessionStorage` fallback.
  - clearAccessToken() removes both.
- The React auth layer is in [frontend/src/contexts/AuthContext.jsx](frontend/src/contexts/AuthContext.jsx):
  - On app init it calls `authService.getStoredToken()` and tries to fetch user info if token exists.
  - Exposes helpers: `login`, `signup`, `socialLogin`, `logout`, `isAuthenticated`, `hasRole`.

Roles & scopes:
- Roles are represented by an enum on the backend: `UserRole` in [auth_service/Domain/Entity/User.cs](auth_service/Domain/Entity/User.cs) (values: Normal_Student, Premium_Student, Instructor, Admin).
- Backend includes role claims in JWT (see token generation code that adds `ClaimTypes.Role`).
- Frontend can check roles via `useAuth().hasRole(role)` which inspects the `user` object (populated after login). Authorization checks (route guards) can be implemented using that helper.

API endpoints (auth service):
- Sign up: POST `/api/auth/signup` (accepts SignUpRequest) — see [AuthController.cs](auth_service/Presentation/Controllers/AuthController.cs)
- Sign in: POST `/api/auth/signin`
- Refresh token: POST `/api/auth/refresh-token` (body contains refresh token)
- Get current user: GET `/api/auth/me` (protected endpoint, Requires Authorization header `Bearer <access_token>`)

Notes about frontend/backend endpoint names:
- The frontend currently includes a mock API at [frontend/src/services/api.js](frontend/src/services/api.js) which uses simplified paths (`/auth/login`, `/auth/signup`, `/auth/me`). When switching from mock to real backend, align the frontend requests with the backend endpoints (`/api/auth/signin`, `/api/auth/signup`, `/api/auth/me`), or add a small adapter in `authService` to map routes.

Refresh token lifecycle (backend):
- On sign-in, backend generates both access and refresh tokens and persists the refresh token and expiry on the User.
- Refresh endpoints validate the refresh token, then issue a new access token (and typically a new refresh token).
- The codebase stores refresh token as a string on the User entity (see [auth_service/Domain/Entity/User.cs](auth_service/Domain/Entity/User.cs)).

Security considerations taken:
- JWTs are signed with a symmetric secret (`JWT:SecretKey`) configured via appsettings / env variables.
- Token validation parameters configured in `Program.cs` (`AddJwtBearer`).
- CORS policy is permissive for development (`AllowAnyOrigin`) — tighten for production.

---

## External/social login
- Social login placeholders exist (frontend `authService.socialLogin` and calls like `socialLogin('google')`), but full OAuth2/OpenID Connect flows are not implemented.
- To add Google sign-in:
  - Backend: implement Google OAuth2 token exchange or accept ID token from frontend, validate token with Google's public keys, and create/sign-in user.
  - Frontend: implement real Google sign-in SDK flow and send ID token to backend.
- Add required provider credentials (client id/secret) in backend configuration and secure them in environment variables.

---

## Decisions & tradeoffs

- Frontend token storage:
  - Chosen: short-term in-memory with sessionStorage mirror (tradeoff: better than localStorage for persistence across tabs? sessionStorage persists per-tab; in-memory cleared on refresh). This is a pragmatic compromise for the demo project. For production, consider:
    - HttpOnly secure cookies for refresh tokens (prevents XSS stealing).
    - Keep access token in-memory only and use cookie-based refresh flow.
- Mock API in frontend:
  - The frontend uses a mock API file for fast UI development ([frontend/src/services/api.js](frontend/src/services/api.js)). This speeds up UI iteration but requires mapping endpoints when switching to the real backend.
- Backend tokens & refresh tokens:
  - Refresh tokens are stored and rotated. The current codebase issues and persists refresh tokens; ensure refresh tokens are stored hashed in DB for better security in production (so DB compromise does not leak valid refresh tokens).
- Role representation:
  - Backend uses enum `UserRole` (simple and type-safe). This maps to a string claim in the JWT; policies and role checks should be implemented server-side for protected operations.
- Database config:
  - `Program.cs` supports `DATABASE_URL` (useful for platforms like Heroku/Neon). It will throw when neither `DATABASE_URL` nor a `DefaultConnection` are configured — ensure correct env variables in CI/CD or dev environment.

---

## Quick links to key files
- Frontend:
  - [frontend/src/services/authService.js](frontend/src/services/authService.js)
  - [frontend/src/contexts/AuthContext.jsx](frontend/src/contexts/AuthContext.jsx)
  - [frontend/src/services/api.js](frontend/src/services/api.js)
  - [frontend/src/App.jsx](frontend/src/App.jsx)
- Backend:
  - [auth_service/Program.cs](auth_service/Program.cs)
  - [auth_service/Infrastructure/Security/JWTGenerator.cs](auth_service/Infrastructure/Security/JWTGenerator.cs)
  - [auth_service/Domain/Entity/User.cs](auth_service/Domain/Entity/User.cs)
  - [auth_service/Infrastructure/Database/DbContext.cs](auth_service/Infrastructure/Database/DbContext.cs)
  - [auth_service/Presentation/Controllers/AuthController.cs](auth_service/Presentation/Controllers/AuthController.cs)

---

If you want, I can:
- Provide step-by-step commands for running both services together (npm + dotnet) in one terminal script.
- Update frontend `authService` to call the real backend endpoints and add an axios/fetch wrapper.
- Harden token storage to use HttpOnly cookies and adapt the backend to support cookie refresh flow.